# Supervisor配置文件 - 适用于所有Linux发行版
# 安装supervisor: sudo apt install supervisor (Ubuntu/Debian)
#                sudo yum install supervisor (CentOS/RHEL)
#                pip install supervisor (通用)
#
# 配置文件位置: /etc/supervisor/conf.d/chaoxing.conf
# 安装命令: sudo cp supervisor.conf /etc/supervisor/conf.d/chaoxing.conf
# 重载配置: sudo supervisorctl reread && sudo supervisorctl update
# 启动所有: sudo supervisorctl start chaoxing:*
# 停止所有: sudo supervisorctl stop chaoxing:*
# 查看状态: sudo supervisorctl status
# 查看日志: sudo supervisorctl tail -f chaoxing:backend

[group:chaoxing]
programs=chaoxing-backend,chaoxing-celery

# FastAPI后端服务
[program:chaoxing-backend]
# 项目路径（请根据实际情况修改）
directory=/opt/chaoxing/web/backend
# 启动命令（使用gunicorn生产部署）
command=/opt/chaoxing/.venv/bin/gunicorn app:app
    --workers 4
    --worker-class uvicorn.workers.UvicornWorker
    --bind 0.0.0.0:8000
    --timeout 120
    --access-logfile /opt/chaoxing/web/backend/logs/access.log
    --error-logfile /opt/chaoxing/web/backend/logs/error.log
    --log-level info

# 环境变量
environment=PYTHONPATH="/opt/chaoxing",PATH="/opt/chaoxing/.venv/bin:%(ENV_PATH)s"

# 运行用户（请根据实际情况修改）
user=www-data
# 自动启动
autostart=true
# 自动重启
autorestart=true
# 启动重试次数
startretries=3
# 停止信号
stopsignal=TERM
# 停止超时时间
stopwaitsecs=10
# 进程启动后等待时间
startsecs=5

# 日志配置
stdout_logfile=/opt/chaoxing/web/backend/logs/supervisor_backend_stdout.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/opt/chaoxing/web/backend/logs/supervisor_backend_stderr.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10

# 重定向标准错误到标准输出
redirect_stderr=false

# Celery Worker服务
[program:chaoxing-celery]
directory=/opt/chaoxing/web/backend
command=/opt/chaoxing/.venv/bin/celery -A celery_app worker
    --loglevel=info
    --concurrency=4
    --max-tasks-per-child=1000
    --time-limit=3600
    --soft-time-limit=3300
    --logfile=/opt/chaoxing/web/backend/logs/celery.log

environment=PYTHONPATH="/opt/chaoxing",PATH="/opt/chaoxing/.venv/bin:%(ENV_PATH)s",C_FORCE_ROOT="true"
user=www-data
autostart=true
autorestart=true
startretries=3
stopsignal=TERM
stopwaitsecs=60
startsecs=10

stdout_logfile=/opt/chaoxing/web/backend/logs/supervisor_celery_stdout.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/opt/chaoxing/web/backend/logs/supervisor_celery_stderr.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10

# Celery Beat定时任务（如果需要）
# [program:chaoxing-celery-beat]
# directory=/opt/chaoxing/web/backend
# command=/opt/chaoxing/.venv/bin/celery -A celery_app beat --loglevel=info
# environment=PYTHONPATH="/opt/chaoxing",PATH="/opt/chaoxing/.venv/bin:%(ENV_PATH)s"
# user=www-data
# autostart=true
# autorestart=true
# startretries=3
# stopsignal=TERM
# stopwaitsecs=10
# stdout_logfile=/opt/chaoxing/web/backend/logs/supervisor_beat_stdout.log
# stderr_logfile=/opt/chaoxing/web/backend/logs/supervisor_beat_stderr.log

