name: Release Build - All Platforms

# å…¨å¹³å°è‡ªåŠ¨æž„å»ºReleaseç‰ˆæœ¬
# æ”¯æŒ: Windows/Mac/Linux + Docker

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€tagæ—¶è§¦å‘ï¼ˆå¦‚ v2.3.0ï¼‰
  workflow_dispatch:  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ 2.3.0ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-frontend:
    name: æž„å»ºå‰ç«¯ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          cd web/frontend
          npm ci
      
      - name: æž„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: |
          cd web/frontend
          npm run build
        env:
          NODE_ENV: production
      
      - name: æ‰“åŒ…å‰ç«¯æ–‡ä»¶
        run: |
          cd web/frontend
          tar -czf frontend-dist.tar.gz dist/
      
      - name: ä¸Šä¼ å‰ç«¯æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/frontend/frontend-dist.tar.gz
          retention-days: 90
  
  # ä¾èµ–éªŒè¯ï¼ˆåœ¨æž„å»ºå‰ï¼‰
  verify-dependencies:
    name: éªŒè¯ä¾èµ–ï¼ˆReleaseæž„å»ºå‰ï¼‰
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ make python3-dev \
            libffi-dev libssl-dev \
            libxml2-dev libxslt1-dev \
            libjpeg-dev libpng-dev zlib1g-dev
      
      - name: å‡çº§pipå’Œæž„å»ºå·¥å…·
        run: |
          pip install --upgrade pip setuptools wheel
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install -r requirements.txt
      
      - name: éªŒè¯ä¾èµ–å®‰è£…
        run: |
          python scripts/verify_dependencies.py
          echo "âœ“ æ‰€æœ‰ä¾èµ–éªŒè¯é€šè¿‡"
      
      - name: éªŒè¯å…³é”®æ¨¡å—
        run: |
          python -c "
          import requests, httpx, fastapi, sqlalchemy, cryptography, lxml, bs4
          print('âœ“ æ‰€æœ‰å…³é”®æ¨¡å—å¯¼å…¥æˆåŠŸ')
          "
  
  build-docker:
    name: æž„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: [build-frontend, verify-dependencies]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½å‰ç«¯æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./artifacts
      
      - name: è§£åŽ‹å‰ç«¯åˆ°æ­£ç¡®ä½ç½®
        run: |
          mkdir -p web/frontend/dist
          tar -xzf artifacts/frontend-dist.tar.gz -C web/frontend/
      
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½•GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: æå–ç‰ˆæœ¬å·å’Œä»“åº“ä¿¡æ¯
        id: meta
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: æž„å»ºå¹¶æŽ¨é€Dockeré•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: web/backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ steps.meta.outputs.REPO_LOWER }}:latest
            ghcr.io/${{ steps.meta.outputs.REPO_LOWER }}:${{ steps.meta.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: éªŒè¯Dockeré•œåƒ
        run: |
          echo "éªŒè¯Dockeré•œåƒæž„å»ºæˆåŠŸ"
          docker pull ghcr.io/${{ steps.meta.outputs.REPO_LOWER }}:${{ steps.meta.outputs.VERSION }} || echo "é•œåƒå°†åœ¨æž„å»ºå®ŒæˆåŽå¯ç”¨"
  
  build-packages:
    name: æž„å»ºå¤šå¹³å°å®‰è£…åŒ…
    runs-on: ${{ matrix.os }}
    needs: [build-frontend, verify-dependencies]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            ext: tar.gz
          - os: macos-latest
            platform: macos-x64
            ext: tar.gz
          - os: windows-latest
            platform: windows-x64
            ext: zip
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½å‰ç«¯æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./artifacts
      
      - name: åˆ›å»ºå¹³å°ç‰¹å®šåŒ…
        shell: bash
        run: |
          # è°ƒè¯•ï¼šæŸ¥çœ‹artifactsç»“æž„
          echo "=== Artifacts structure ==="
          ls -lah artifacts/
          find artifacts/ -type f
          
          # è°ƒè¯•ï¼šæŸ¥çœ‹æºç ç›®å½•å¤§å°
          echo "=== Source directories ==="
          du -sh api/ web/ docs/ tools/ scripts/
          ls -lah api/ | head -20
          ls -lah web/backend/ | head -20
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release-package
          
          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp -r api release-package/
          cp -r docs release-package/
          cp -r tools release-package/
          cp -r scripts release-package/
          cp main.py release-package/
          cp requirements.txt release-package/
          cp README.md release-package/
          cp LICENSE release-package/
          cp config_template.ini release-package/
          cp pytest.ini release-package/
          cp pyproject.toml release-package/
          
          # å¤åˆ¶webç›®å½•ï¼ˆæŽ’é™¤frontendæºç ï¼Œåªä¿ç•™backendï¼‰
          mkdir -p release-package/web
          cp -r web/backend release-package/web/
          # å¦‚æžœæœ‰å…¶ä»–webå­ç›®å½•ï¼ˆnginxç­‰ï¼‰ï¼Œä¹Ÿå¤åˆ¶
          [ -d "web/nginx" ] && cp -r web/nginx release-package/web/ || true
          [ -f "web/docker-compose.yml" ] && cp web/docker-compose.yml release-package/web/ || true
          
          # å¤åˆ¶å¹³å°ç‰¹å®šè„šæœ¬
          if [ "${{ matrix.platform }}" = "windows-x64" ]; then
            cp daemon_control.bat release-package/
            cp ä¸€é”®å®‰è£….bat release-package/
            cp scripts/backup.bat release-package/scripts/
          else
            cp daemon_control.sh release-package/
            cp ä¸€é”®å®‰è£….sh release-package/
            cp scripts/backup.sh release-package/scripts/
            chmod +x release-package/daemon_control.sh
            chmod +x release-package/ä¸€é”®å®‰è£….sh
            chmod +x release-package/scripts/backup.sh
          fi
          
          # å¤åˆ¶æ–‡æ¡£ï¼ˆä»Ždocsç›®å½•ï¼‰
          cp docs/DAEMON.md release-package/ 2>/dev/null || echo "DAEMON.md not found, skipping"
          
          # è§£åŽ‹å‰ç«¯æž„å»ºäº§ç‰©ï¼ˆä¿®å¤è·¯å¾„ï¼‰
          mkdir -p release-package/web/frontend
          if [ -f "artifacts/frontend-dist.tar.gz" ]; then
            tar -xzf artifacts/frontend-dist.tar.gz -C release-package/web/frontend/
          elif [ -f "artifacts/frontend-dist/frontend-dist.tar.gz" ]; then
            tar -xzf artifacts/frontend-dist/frontend-dist.tar.gz -C release-package/web/frontend/
          else
            echo "ERROR: frontend-dist.tar.gz not found!"
            exit 1
          fi
          
          # éªŒè¯å‰ç«¯æ–‡ä»¶
          echo "=== Frontend files ==="
          ls -lah release-package/web/frontend/dist/ || echo "No dist directory!"
          
          # éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨
          echo "=== éªŒè¯å…³é”®æ–‡ä»¶ ==="
          test -f release-package/requirements.txt && echo "âœ“ requirements.txtå­˜åœ¨" || echo "âœ— requirements.txtç¼ºå¤±"
          test -f release-package/main.py && echo "âœ“ main.pyå­˜åœ¨" || echo "âœ— main.pyç¼ºå¤±"
          test -d release-package/api && echo "âœ“ apiç›®å½•å­˜åœ¨" || echo "âœ— apiç›®å½•ç¼ºå¤±"
          test -d release-package/scripts && echo "âœ“ scriptsç›®å½•å­˜åœ¨" || echo "âœ— scriptsç›®å½•ç¼ºå¤±"
          test -f release-package/scripts/verify_dependencies.py && echo "âœ“ verify_dependencies.pyå­˜åœ¨" || echo "âœ— verify_dependencies.pyç¼ºå¤±"
          test -f release-package/scripts/install_system_deps.sh && echo "âœ“ install_system_deps.shå­˜åœ¨" || echo "âœ— install_system_deps.shç¼ºå¤±"
          
          # éªŒè¯å®Œæ•´åŒ…å¤§å°
          echo "=== Package size ==="
          du -sh release-package/
          du -sh release-package/*
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
          echo "Version: ${GITHUB_REF_NAME:-latest}" > release-package/VERSION.txt
          echo "Platform: ${{ matrix.platform }}" >> release-package/VERSION.txt
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> release-package/VERSION.txt
          echo "Commit: ${GITHUB_SHA}" >> release-package/VERSION.txt
          
          # åˆ›å»ºå¹³å°è¯´æ˜Ž
          cat > release-package/INSTALL_${{ matrix.platform }}.txt << 'EOF'
          # å®‰è£…è¯´æ˜Ž - ${{ matrix.platform }}
          
          ## å¿«é€Ÿå¼€å§‹
          
          ### Windows
          1. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          2. åŒå‡»è¿è¡Œ: ä¸€é”®å®‰è£….bat
          3. æŒ‰æç¤ºé€‰æ‹©è¿è¡Œæ¨¡å¼
          
          ### Linux/macOS
          1. è§£åŽ‹: tar -xzf æ–‡ä»¶å.tar.gz
          2. è¿›å…¥ç›®å½•: cd release-package
          3. è¿è¡Œ: ./ä¸€é”®å®‰è£….sh
          
          ## è¯¦ç»†æ–‡æ¡£
          æŸ¥çœ‹ README.md å’Œ docs/ ç›®å½•
          EOF
      
      - name: æ‰“åŒ…ï¼ˆLinux/macOSï¼‰
        if: matrix.platform != 'windows-x64'
        run: |
          tar -czf chaoxing-${GITHUB_REF_NAME:-latest}-${{ matrix.platform }}.tar.gz release-package/
      
      - name: æ‰“åŒ…ï¼ˆWindowsï¼‰
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          Compress-Archive -Path release-package/* -DestinationPath chaoxing-$env:GITHUB_REF_NAME-${{ matrix.platform }}.zip
      
      - name: ä¸Šä¼ å¹³å°åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.platform }}
          path: |
            *.tar.gz
            *.zip
          retention-days: 90
  
  create-release:
    name: åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: [build-frontend, build-docker, build-packages]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: åˆ›å»ºé€šç”¨åŒ…
        run: |
          # åˆ›å»ºsource-onlyåŒ…ï¼ˆä¸å«å‰ç«¯æž„å»ºï¼‰
          mkdir -p source-package
          cp -r api source-package/
          cp -r web source-package/
          cp -r docs source-package/
          cp -r tools source-package/
          cp -r scripts source-package/
          cp main.py source-package/
          cp requirements.txt source-package/
          cp README.md source-package/
          cp LICENSE source-package/
          cp config_template.ini source-package/
          cp pytest.ini source-package/
          cp pyproject.toml source-package/
          cp daemon_control.sh source-package/
          cp daemon_control.bat source-package/
          cp ä¸€é”®å®‰è£….sh source-package/
          cp ä¸€é”®å®‰è£….bat source-package/
          
          # å¤åˆ¶æ–‡æ¡£ï¼ˆä»Ždocsç›®å½•ï¼‰
          cp docs/DAEMON.md source-package/ 2>/dev/null || echo "DAEMON.md not found, skipping"
          
          tar -czf chaoxing-${GITHUB_REF_NAME}-source.tar.gz source-package/
          
          # åˆ›å»ºä»…å‰ç«¯åŒ…ï¼ˆç”¨äºŽæ›´æ–°ï¼‰
          mkdir -p frontend-only
          tar -xzf artifacts/frontend-dist/frontend-dist.tar.gz -C frontend-only/
          tar -czf chaoxing-${GITHUB_REF_NAME}-frontend-only.tar.gz -C frontend-only dist/
          
          # K8sé…ç½®å·²ç§»é™¤
      
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          
          # ç§»åŠ¨å¹³å°ç‰¹å®šåŒ…
          mv artifacts/package-linux-x64/*.tar.gz release-files/ 2>/dev/null || true
          mv artifacts/package-macos-x64/*.tar.gz release-files/ 2>/dev/null || true
          mv artifacts/package-windows-x64/*.zip release-files/ 2>/dev/null || true
          
          # ç§»åŠ¨é€šç”¨åŒ…
          mv chaoxing-${GITHUB_REF_NAME}-source.tar.gz release-files/
          mv chaoxing-${GITHUB_REF_NAME}-frontend-only.tar.gz release-files/
          # K8såŒ…å·²ç§»é™¤
          
          ls -lh release-files/
      
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"
          
          cat > release_notes.md << 'HEREDOC'
          ## ðŸ“¦ ä¸‹è½½é€‰æ‹©æŒ‡å—
          
          ### ðŸŒŸ æŽ¨èä¸‹è½½ï¼ˆæŒ‰ä½¿ç”¨åœºæ™¯ï¼‰
          
          #### 1. æ™®é€šç”¨æˆ·ï¼ˆWindowsï¼‰
          - **chaoxing-${VERSION}-windows-x64.zip**
          - âœ… Windowsä¸“ç”¨
          - âœ… åŒ…å«å‰ç«¯æž„å»º
          - âœ… åŒå‡».batå³å¯å®‰è£…
          
          #### 2. æ™®é€šç”¨æˆ·ï¼ˆMacï¼‰
          - **chaoxing-${VERSION}-macos-x64.tar.gz**
          - âœ… macOSä¸“ç”¨
          - âœ… åŒ…å«å‰ç«¯æž„å»º
          - âœ… è¿è¡Œ.shå³å¯å®‰è£…
          
          #### 3. LinuxæœåŠ¡å™¨
          - **chaoxing-${VERSION}-linux-x64.tar.gz**
          - âœ… Linuxä¸“ç”¨
          - âœ… åŒ…å«å‰ç«¯æž„å»º
          - âœ… æ”¯æŒå®ˆæŠ¤è¿›ç¨‹
          
          #### 4. Dockerç”¨æˆ·
          - **ç›´æŽ¥æ‹‰å–é•œåƒ**
          - `docker pull ghcr.io/${GITHUB_REPOSITORY}:${GITHUB_REF_NAME}`
          - âœ… å¤šæž¶æž„æ”¯æŒï¼ˆamd64/arm64ï¼‰
          - âœ… ä¸€é”®éƒ¨ç½²
          
          #### 5. å¼€å‘è€…
          - **chaoxing-${VERSION}-source.tar.gz**
          - âœ… å®Œæ•´æºç 
          - âœ… ä¸å«å‰ç«¯æž„å»º
          - âœ… éœ€è¦è‡ªè¡Œæž„å»º
          
          ---
          
          ## ðŸ“‹ æ‰€æœ‰ä¸‹è½½æ–‡ä»¶è¯´æ˜Ž
          
          ### å¹³å°ç‰¹å®šåŒ…ï¼ˆåŒ…å«å‰ç«¯æž„å»ºï¼‰â­æŽ¨è
          | æ–‡ä»¶ | å¹³å° | å¤§å° | è¯´æ˜Ž |
          |------|------|------|------|
          | **windows-x64.zip** | Windows | ~50MB | Windowsä¸“ç”¨ï¼Œå«å‰ç«¯ |
          | **macos-x64.tar.gz** | macOS | ~50MB | macOSä¸“ç”¨ï¼Œå«å‰ç«¯ |
          | **linux-x64.tar.gz** | Linux | ~50MB | Linuxä¸“ç”¨ï¼Œå«å‰ç«¯ |
          
          ### é€šç”¨åŒ…
          | æ–‡ä»¶ | ç”¨é€” | å¤§å° | è¯´æ˜Ž |
          |------|------|------|------|
          | **source.tar.gz** | æºç åŒ… | ~30MB | ä¸å«å‰ç«¯æž„å»ºï¼Œéœ€è‡ªè¡Œbuild |
          | **frontend-only.tar.gz** | å‰ç«¯æ›´æ–° | ~5MB | ä»…å‰ç«¯distï¼Œç”¨äºŽæ›´æ–° |
          
          ### Dockeré•œåƒðŸ³
          ```bash
          # GitHub Container Registryï¼ˆé•œåƒåç§°è‡ªåŠ¨è½¬ä¸ºå°å†™ï¼‰
          # å¦‚æžœä»“åº“æ˜¯ ViVi141/chaoxingï¼Œé•œåƒä¼šæ˜¯ vivi141/chaoxing
          docker pull ghcr.io/vivi141/chaoxing:${GITHUB_REF_NAME}
          docker pull ghcr.io/vivi141/chaoxing:latest
          ```
          
          **æ”¯æŒæž¶æž„**: linux/amd64, linux/arm64
          
          **æ³¨æ„**: Dockeré•œåƒå‘å¸ƒåˆ°GitHub Container Registryï¼Œä»“åº“åç§°è‡ªåŠ¨è½¬æ¢ä¸ºå°å†™ã€‚
          
          ---
          
          ## ðŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆæŒ‰å¹³å°ï¼‰
          
          ### æ–¹å¼1ï¼šDockerï¼ˆæœ€ç®€å•ï¼‰
          ```bash
          # æ‹‰å–é•œåƒï¼ˆé•œåƒåç§°ä¸ºå°å†™ï¼‰
          docker pull ghcr.io/vivi141/chaoxing:${GITHUB_REF_NAME}
          
          # å¯åŠ¨å®Œæ•´çŽ¯å¢ƒ
          wget https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/web/docker-compose.yml
          docker compose up -d
          ```
          
          ### æ–¹å¼2ï¼šæºç éƒ¨ç½²
          ```bash
          # 1. ä¸‹è½½å¹¶è§£åŽ‹å®Œæ•´åŒ…
          wget https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/chaoxing-${GITHUB_REF_NAME}-full.tar.gz
          tar -xzf chaoxing-${GITHUB_REF_NAME}-full.tar.gz
          cd release-package
          
          # 2. å®‰è£…Pythonä¾èµ–
          pip install -r requirements.txt
          
          # 3. å¯åŠ¨æœåŠ¡ï¼ˆå·²åŒ…å«å‰ç«¯æž„å»ºï¼‰
          ./daemon_control.sh start  # Linux
          daemon_control.bat start   # Windows
          ```
          
          ## ðŸ“ æ›´æ–°æ—¥å¿—
          
          è¯¦è§ [CHANGELOG.md](https://github.com/${REPO}/blob/main/docs/CHANGELOG.md)
          HEREDOC
          
          # æ›¿æ¢æ‰€æœ‰å˜é‡ä¸ºå®žé™…å€¼
          sed -i "s/\${VERSION}/${VERSION}/g" release_notes.md
          sed -i "s|\${REPO}|${REPO}|g" release_notes.md
          sed -i "s/\${GITHUB_REF_NAME}/${VERSION}/g" release_notes.md
          sed -i "s|\${GITHUB_REPOSITORY}|${REPO}|g" release_notes.md
          
          # éªŒè¯æ›¿æ¢ç»“æžœ
          echo "=== Release notes preview ==="
          head -50 release_notes.md
          
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
      
      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          body_path: release_notes.md
          draft: false
          prerelease: false
          name: Release ${{ github.ref_name }}
          fail_on_unmatched_files: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

