name: Docker构建和测试

# Docker镜像构建和测试工作流
# 确保Docker镜像能正确构建并包含所有依赖

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'web/backend/Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/docker-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'web/backend/Dockerfile'
      - 'requirements.txt'
  workflow_dispatch:  # 支持手动触发

jobs:
  # 测试Docker构建
  test-docker-build:
    name: 测试Docker构建
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: 构建Docker镜像（测试）
        uses: docker/build-push-action@v5
        with:
          context: .
          file: web/backend/Dockerfile
          push: false
          tags: chaoxing:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 验证镜像构建成功
        run: |
          docker images | grep chaoxing
          echo "✓ Docker镜像构建成功"
  
  # 测试Docker镜像中的依赖
  test-docker-dependencies:
    name: 测试Docker镜像依赖
    runs-on: ubuntu-latest
    needs: [test-docker-build]
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: 构建Docker镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          file: web/backend/Dockerfile
          push: false
          tags: chaoxing:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 测试镜像中的Python依赖
        run: |
          docker run --rm chaoxing:test python -c "
          import sys
          modules = [
              'requests', 'httpx', 'urllib3',
              'bs4', 'lxml',
              'cryptography', 'pyaes',
              'loguru',
              'fastapi', 'uvicorn',
              'sqlalchemy', 'alembic',
              'pydantic', 'pydantic_settings',
              'jose', 'passlib',
              'websockets', 'aiohttp'
          ]
          failed = []
          for mod in modules:
              try:
                  __import__(mod)
                  print(f'✓ {mod}')
              except ImportError as e:
                  print(f'✗ {mod}: {e}')
                  failed.append(mod)
          if failed:
              print(f'失败模块: {failed}')
              sys.exit(1)
          print('所有关键模块导入成功！')
          "
      
      - name: 测试依赖验证脚本
        run: |
          docker run --rm -v $(pwd)/scripts:/scripts chaoxing:test python /scripts/verify_dependencies.py || echo "注意：脚本路径可能需要调整"
      
      - name: 测试应用启动（健康检查）
        run: |
          # 启动容器并检查健康状态
          docker run -d --name chaoxing-test -p 8000:8000 chaoxing:test
          sleep 10
          
          # 检查容器是否运行
          docker ps | grep chaoxing-test
          
          # 清理
          docker stop chaoxing-test
          docker rm chaoxing-test
          echo "✓ 容器启动测试通过"
  
  # 测试多架构构建
  test-multi-arch:
    name: 测试多架构构建
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: 测试amd64架构构建
        uses: docker/build-push-action@v5
        with:
          context: .
          file: web/backend/Dockerfile
          push: false
          platforms: linux/amd64
          tags: chaoxing:test-amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 测试arm64架构构建
        uses: docker/build-push-action@v5
        with:
          context: .
          file: web/backend/Dockerfile
          push: false
          platforms: linux/arm64
          tags: chaoxing:test-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 验证多架构构建
        run: |
          echo "✓ amd64架构构建成功"
          echo "✓ arm64架构构建成功"
  
  # Docker测试总结
  docker-test-summary:
    name: Docker测试总结
    runs-on: ubuntu-latest
    needs: [test-docker-build, test-docker-dependencies, test-multi-arch]
    if: always()
    
    steps:
      - name: 生成测试报告
        run: |
          echo "## Docker构建和测试结果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 测试项 | 状态 |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docker构建测试 | ${{ needs.test-docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 依赖验证测试 | ${{ needs.test-docker-dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 多架构构建测试 | ${{ needs.test-multi-arch.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "所有Docker测试完成！" >> $GITHUB_STEP_SUMMARY

