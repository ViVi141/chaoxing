================================
✅ 任务创建422错误已修复
================================

【问题原因】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 错误: Request failed with status code 422

🔍 根本原因:
   - 后端期望 course_ids 是数组: List[str]
   - 前端发送的是字符串: "id1,id2,id3"
   - 数据类型不匹配导致验证失败

【修复内容】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 1. 数据格式修正
   之前: values.course_ids = selectedCourseIds.join(',')  // 字符串
   现在: course_ids: selectedCourseIds  // 数组

✅ 2. 字段名修正
   之前: course_name (不匹配后端schema)
   现在: name (匹配 TaskCreate.name)

✅ 3. 数据结构优化
   提交数据:
   {
     "name": "任务名称",
     "course_ids": ["256367723", "256367724"]
   }

✅ 4. 添加调试日志
   console.log('提交任务数据:', submitData)

【后端Schema】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

class TaskCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=200)
    course_ids: Optional[List[str]] = Field(None)

必需字段:
- name: 任务名称（字符串）

可选字段:
- course_ids: 课程ID列表（字符串数组）

【前端提交逻辑】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 验证课程选择
   if (selectedCourseIds.length === 0) {
     message.error('请至少选择一门课程');
   }

2. 准备数据
   const submitData = {
     name: values.task_name || firstCourse.courseName,
     course_ids: selectedCourseIds  // 数组格式
   };

3. 提交
   return formProps.onFinish?.(submitData);

【测试步骤】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 刷新浏览器 (Ctrl + F5)
2. 进入"任务管理" → "创建"
3. 等待课程列表加载
4. 勾选1-2门课程
5. 填写任务名称（可选）
6. 点击"保存"
7. 查看浏览器控制台的日志
8. 确认任务创建成功

【预期结果】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 控制台输出:
   提交任务数据: {
     name: "民歌鉴赏",
     course_ids: ["256367723"]
   }

✅ 后端响应:
   201 Created
   { id: 1, name: "民歌鉴赏", status: "pending", ... }

✅ 页面跳转:
   自动跳转到任务列表
   显示新创建的任务

【相关文件】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 前端:
   web/frontend/src/pages/tasks/create-full.tsx

✅ 后端:
   web/backend/routes/task.py
   web/backend/schemas.py (TaskCreate)
   web/backend/models.py (Task)

【数据流】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

前端表单
  ↓
handleSubmit() 处理
  ↓
准备 submitData {name, course_ids[]}
  ↓
formProps.onFinish() (Refine)
  ↓
dataProvider.create()
  ↓
POST /api/tasks
  ↓
TaskCreate schema 验证
  ↓
创建 Task 对象
  ↓
保存到数据库
  ↓
返回 201 + TaskResponse

【常见问题】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Q1: 仍然422错误？
A1: 检查浏览器控制台日志，确认提交的数据格式

Q2: course_ids是空的？
A2: 确保勾选了课程，selectedCourseIds不为空

Q3: 任务名称为空？
A3: 
   - 方案1: 手动填写任务名称
   - 方案2: 系统自动使用第一门课程名称

Q4: 如何验证修复？
A4: 
   1. 打开浏览器开发者工具（F12）
   2. 切换到Console标签
   3. 创建任务
   4. 查看"提交任务数据"日志
   5. 确认course_ids是数组格式

================================
✅ 修复完成，可以正常创建任务了！
================================

